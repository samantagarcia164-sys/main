<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VÃ´lei Pro - GestÃ£o e Sorteio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-tab { border-bottom: 4px solid #ffffff; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen font-sans text-slate-800">

    <div class="max-w-md mx-auto bg-slate-100 min-h-screen shadow-2xl flex flex-col">
        
        <div class="bg-blue-600 flex text-white pt-2">
            <button onclick="mudarAba('lista')" id="btn-lista" class="flex-1 py-3 active-tab">Lista e Pagamento</button>
            <button onclick="mudarAba('sorteio')" id="btn-sorteio" class="flex-1 py-3">Sorteio de Times</button>
        </div>

        <div id="aba-lista" class="p-4 space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <input type="text" id="chavePix" value="Chave PIX: (Clique para editar)" class="text-xs font-bold text-blue-600 bg-transparent border-none focus:ring-0 w-full">
                </div>
                <div class="flex justify-between text-sm mb-1 font-bold">
                    <span>Progresso da Quadra</span>
                    <span id="valorPorPessoa">R$ 0,00 / pessoa</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-4 mb-2">
                    <div id="barraProgresso" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="statusFinanceiro" class="text-[10px] text-slate-500 text-center uppercase tracking-wider font-bold">R$ 0 de R$ 350 arrecadados</p>
            </div>

            <div class="flex gap-2">
                <input type="text" id="nomeJogador" placeholder="Nome do jogador..." class="flex-1 p-3 rounded-xl border-none shadow-inner focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="window.adicionarJogador()" class="bg-blue-600 text-white px-5 py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all">+</button>
            </div>

            <ul id="listaJogadores" class="space-y-2"></ul>
        </div>

        <div id="aba-sorteio" class="p-4 space-y-4 hidden">
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <h2 class="font-bold text-blue-800 mb-2 italic">Apenas jogadores com "PIX OK" serÃ£o sorteados.</h2>
                <div class="flex items-center gap-3">
                    <label class="text-sm font-medium">Jogadores por time:</label>
                    <input type="number" id="qtdPorTime" value="6" class="w-16 p-2 rounded-lg border-none shadow-sm text-center font-bold">
                </div>
                <button onclick="sortearTimes()" class="w-full mt-4 bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-orange-600 active:scale-95 transition-all uppercase tracking-widest">Sortear Times ðŸŽ²</button>
            </div>
            
            <div id="resultadoSorteio" class="space-y-4">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxQThqrjNEXmmpreEQwRBaihTAIpoZaAM",
            authDomain: "voleigrupo-b8a5a.firebaseapp.com",
            projectId: "voleigrupo-b8a5a",
            storageBucket: "voleigrupo-b8a5a.firebasestorage.app",
            messagingSenderId: "619450859287",
            appId: "1:619450859287:web:bf9138713eb65b3c514152",
            measurementId: "G-7G4HZDHHYV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const jogadoresCol = collection(db, "jogadores");
        let jogadoresAtuais = [];

        // Controle de Abas
        window.mudarAba = (aba) => {
            document.getElementById('aba-lista').classList.toggle('hidden', aba !== 'lista');
            document.getElementById('aba-sorteio').classList.toggle('hidden', aba !== 'sorteio');
            document.getElementById('btn-lista').classList.toggle('active-tab', aba === 'lista');
            document.getElementById('btn-sorteio').classList.toggle('active-tab', aba === 'sorteio');
        };

        // Escuta Banco de Dados
        const q = query(jogadoresCol, orderBy("nome", "asc"));
        onSnapshot(q, (snapshot) => {
            const lista = document.getElementById('listaJogadores');
            lista.innerHTML = '';
            jogadoresAtuais = [];
            
            let pagos = 0;
            snapshot.forEach((docSnap) => {
                const j = { id: docSnap.id, ...docSnap.data() };
                jogadoresAtuais.push(j);
                if(j.pago) pagos++;
                
                const item = document.createElement('li');
                item.className = `flex justify-between items-center p-4 rounded-xl border-l-4 shadow-sm ${j.pago ? 'bg-white border-green-500' : 'bg-white border-red-400'}`;
                item.innerHTML = `
                    <span class="font-bold text-slate-700">${j.nome}</span>
                    <div class="flex items-center gap-3">
                        <button onclick="window.togglePix('${j.id}', ${j.pago})" class="text-[10px] px-3 py-1.5 rounded-lg font-black text-white ${j.pago ? 'bg-green-500' : 'bg-red-400'}">
                            ${j.pago ? 'PIX OK' : 'PENDENTE'}
                        </button>
                        <button onclick="window.remover('${j.id}')" class="text-slate-300 text-xl">Ã—</button>
                    </div>`;
                lista.appendChild(item);
            });

            atualizarFinanceiro(jogadoresAtuais.length, pagos);
        });

        function atualizarFinanceiro(totalPessoas, totalPagos) {
            const custoTotal = 350;
            const valorPorPessoa = totalPessoas > 0 ? (custoTotal / totalPessoas).toFixed(2) : "0.00";
            const arrecadado = (totalPagos * (custoTotal / totalPessoas || 0)).toFixed(0);
            const porcentagem = (totalPagos / totalPessoas * 100) || 0;

            document.getElementById('valorPorPessoa').innerText = `R$ ${valorPorPessoa} / pessoa`;
            document.getElementById('barraProgresso').style.width = `${porcentagem}%`;
            document.getElementById('statusFinanceiro').innerText = `${totalPagos} de ${totalPessoas} pessoas pagaram`;
        }

        window.adicionarJogador = async () => {
            const input = document.getElementById('nomeJogador');
            if (input.value.trim()) {
                await addDoc(jogadoresCol, { nome: input.value.trim(), pago: false });
                input.value = '';
            }
        };

        window.togglePix = async (id, status) => {
            await updateDoc(doc(db, "jogadores", id), { pago: !status });
        };

        window.remover = async (id) => {
            if(confirm("Remover?")) await deleteDoc(doc(db, "jogadores", id));
        };

        // LÃ³gica de Sorteio
        window.sortearTimes = () => {
            const pagos = jogadoresAtuais.filter(j => j.pago);
            const qtdPorTime = parseInt(document.getElementById('qtdPorTime').value);
            const resultadoDiv = document.getElementById('resultadoSorteio');
            
            if (pagos.length < 2) return alert("Precisa de pelo menos 2 pessoas com PIX OK!");

            // Shuffle (Embaralhar)
            const sorteados = pagos.sort(() => Math.random() - 0.5);
            resultadoDiv.innerHTML = '';

            let timeAtual = [];
            let contadorTime = 1;

            for (let i = 0; i < sorteados.length; i++) {
                timeAtual.push(sorteados[i].nome);
                
                if (timeAtual.length == qtdPorTime || i == sorteados.length - 1) {
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-2xl shadow-md border-t-4 border-orange-500";
                    card.innerHTML = `<h3 class="font-black text-orange-600 mb-2">TIME ${contadorTime}</h3>
                                      <p class="text-slate-600 font-medium">${timeAtual.join(', ')}</p>`;
                    resultadoDiv.appendChild(card);
                    timeAtual = [];
                    contadorTime++;
                }
            }
        };
    </script>
</body>
</html>
