<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>V√¥lei Pro - Ligas</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèê</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23007aff' d='M256 48C141.1 48 48 141.1 48 256s93.1 208 208 208 208-93.1 208-208S370.9 48 256 48zm0 32c25.4 0 49.8 5.6 71.9 15.6l-50.5 87.4c-6.9-1.9-14.1-3-21.4-3s-14.5 1.1-21.4 3l-50.5-87.4C206.2 85.6 230.6 80 256 80zM102 169.5c15.2-26.4 36.6-48.4 62-64.3l50.5 87.4c-11.1 6.4-20.2 15.5-26.6 26.6l-85.9 0c0-.1 0-.1 0 0zM80 256c0-14 1.7-27.6 4.9-40.6l85.9 0c-1.9 6.9-3 14.1-3 21.4s1.1 14.5 3 21.4H84.9C81.7 283.6 80 270 80 256zm22 86.5l85.9 0c6.4 11.1 15.5 20.2 26.6 26.6l-50.5 87.4c-25.4-15.9-46.8-37.9-62-64.3l0 .3zm154 89.5c-25.4 0-49.8-5.6-71.9-15.6l50.5-87.4c6.9 1.9 14.1 3 21.4 3s14.5-1.1 21.4-3l50.5 87.4C305.8 424.4 281.4 430 256 430zm154-87.5c-15.2 26.4-36.6 48.4-62 64.3l-50.5-87.4c11.1-6.4 20.2-15.5 26.6-26.6l85.9 0zM432 256c0 14-1.7 27.6-4.9 40.6h-85.9c1.9-6.9 3-14.1 3-21.4s-1.1-14.5-3-21.4h85.9c3.2 13 4.9 26.6 4.9 40.6zm-22-86.5h-85.9c-6.4-11.1-15.5-20.2-26.6-26.6l50.5-87.4c25.4 15.9 46.8 37.9 62 64.3l0-.3z'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --ios-blue: #007aff; --ios-orange: #ff9500; }
        body { font-family: -apple-system, sans-serif; -webkit-font-smoothing: antialiased; background-color: #000; color: #fff; overflow-x: hidden; touch-action: manipulation; }
        .liquid-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient(135deg, #1d1d1f 0%, #000 100%); }
        .metaball { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.3; }
        .metaball:nth-child(1) { width: 300px; height: 300px; top: -5%; left: -10%; background: var(--ios-blue); }
        .metaball:nth-child(2) { width: 400px; height: 400px; bottom: -10%; right: -10%; background: var(--ios-orange); }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-menu { background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-input { background: rgba(255, 255, 255, 0.07); border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; outline: none; width: 100%; padding: 0.8rem; border-radius: 1rem; }
        .ios-btn { transition: transform 0.1s; cursor: pointer; user-select: none; }
        .ios-btn:active { transform: scale(0.95); opacity: 0.8; }
        .active-tab { color: var(--ios-blue); font-weight: 900; }
        .hidden { display: none !important; }
        .animate-in { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .placar-numero { font-size: 5.5rem; font-weight: 900; line-height: 1; text-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .badge-live { background: #ef4444; animation: pulse 2s infinite; padding: 2px 8px; border-radius: 4px; font-size: 8px; font-weight: 900; color: white; vertical-align: middle; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .admin-delete-btn { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; background: rgba(239, 68, 68, 0.15); color: #f87171; border-radius: 12px; transition: all 0.2s; }
        .admin-delete-btn:active { background: rgba(239, 68, 68, 0.3); transform: scale(0.9); }
    </style>
</head>
<body class="pb-32">

    <div class="liquid-bg"><div class="metaball"></div><div class="metaball"></div></div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black">
        <div class="glass-card p-10 rounded-[2.5rem] w-full max-w-sm text-center animate-in flex flex-col items-center">
            <div class="w-24 h-24 rounded-full bg-blue-600/20 border-4 border-white/10 flex items-center justify-center mb-6 shadow-2xl">
                <i class="fas fa-volleyball-ball text-5xl text-blue-500 animate-bounce"></i>
            </div>
            <h1 class="text-3xl font-black italic mb-8 uppercase tracking-tighter">V√¥lei <span class="text-blue-500">Pro</span></h1>
            <button id="google-login-btn" class="ios-btn w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-xs flex items-center justify-center gap-3 mb-4">
                <i class="fab fa-google text-red-500"></i> Google Login
            </button>
            <div class="w-full flex items-center gap-2 opacity-20 mb-4"><hr class="flex-1 border-white/30"> <span class="text-[9px] font-bold">OU E-MAIL</span> <hr class="flex-1 border-white/30"></div>
            <input type="email" id="emailInput" class="glass-input text-sm mb-3" placeholder="E-mail">
            <input type="password" id="passInput" class="glass-input text-sm mb-6" placeholder="Senha">
            <div class="flex gap-2 w-full">
                <button id="email-login-btn" class="ios-btn flex-1 bg-blue-600 py-4 rounded-2xl font-black text-[10px] uppercase">Entrar</button>
                <button id="register-btn" class="ios-btn flex-1 bg-white/10 py-4 rounded-2xl font-black text-[10px] uppercase">Criar</button>
            </div>
        </div>
    </div>

    <div id="league-screen" class="fixed inset-0 z-40 flex flex-col p-6 bg-transparent hidden animate-in pt-12">
        <h2 class="text-3xl font-black italic uppercase mb-2">Suas <span class="text-blue-500">Ligas</span></h2>
        <p class="text-xs opacity-50 mb-8 font-bold tracking-wider">Grupos que voc√™ participa</p>
        
        <div class="flex gap-3 mb-8">
            <button onclick="window.criarLiga()" class="ios-btn flex-1 bg-blue-600 py-4 rounded-2xl font-black uppercase text-[10px] shadow-xl shadow-blue-500/20"><i class="fas fa-plus mr-1"></i> Criar Nova</button>
            <button onclick="window.entrarComCodigo()" class="ios-btn flex-1 bg-white/10 py-4 rounded-2xl font-black uppercase text-[10px]"><i class="fas fa-key mr-1"></i> Usar C√≥digo</button>
        </div>
        
        <div class="flex-1 overflow-y-auto pb-10 space-y-3" id="lista-ligas-disponiveis">
            <div class="text-center opacity-40 text-xs mt-10">Buscando suas ligas...</div>
        </div>
        
        <button onclick="window.sair()" class="text-red-400 text-xs font-black uppercase mt-6 opacity-50 text-center w-full py-4">Fazer Logout</button>
    </div>

    <div id="main-app" class="max-w-md mx-auto hidden">
        <header class="p-6 pt-10 flex justify-between items-center border-b border-white/5 pb-4 mb-4">
            <div class="flex flex-col w-2/3">
                <h1 id="nome-liga-header" class="text-xl font-black italic uppercase truncate">Nome da Liga</h1>
                <span id="badge-codigo" onclick="window.copiarCodigo()" class="text-[9px] font-black text-blue-400 mt-1 cursor-pointer w-fit bg-blue-500/10 px-2 py-1 rounded-md transition hover:bg-blue-500/20">
                    <i class="fas fa-copy mr-1"></i> ID: <span id="codigo-texto">...</span>
                </span>
            </div>
            <div class="flex gap-2">
                <button id="btnAdmin" onclick="window.abrirAdmin()" class="hidden glass-card px-4 py-2 rounded-2xl text-orange-400"><i class="fas fa-crown"></i></button>
                <button onclick="window.copiarPix()" class="glass-card px-4 py-2 rounded-2xl text-[10px] font-black uppercase">PIX</button>
            </div>
        </header>

        <main class="px-5 space-y-6">
            <div id="aba-placar" class="aba-content animate-in space-y-6">
                <div id="match-card" class="glass-card rounded-[2.5rem] p-8 relative overflow-hidden">
                    <div class="absolute top-4 left-0 w-full text-center"><span class="badge-live">LIVE MATCH</span></div>
                    <div class="flex justify-around items-center pt-4">
                        <div class="text-center w-2/5">
                            <input type="text" id="nomeA" value="TIME A" class="bg-transparent text-center font-black text-xs uppercase mb-4 w-full outline-none">
                            <div id="pontosA" class="placar-numero text-blue-400 ios-btn" onclick="window.alterarPlacar('A', 1)">0</div>
                            <button onclick="window.alterarPlacar('A', -1)" class="opacity-20 mt-4 text-xs font-bold">-1 PONTO</button>
                        </div>
                        <div class="font-black opacity-10 text-2xl italic pt-6">VS</div>
                        <div class="text-center w-2/5">
                            <input type="text" id="nomeB" value="TIME B" class="bg-transparent text-center font-black text-xs uppercase mb-4 w-full outline-none">
                            <div id="pontosB" class="placar-numero text-orange-400 ios-btn" onclick="window.alterarPlacar('B', 1)">0</div>
                            <button onclick="window.alterarPlacar('B', -1)" class="opacity-20 mt-4 text-xs font-bold">-1 PONTO</button>
                        </div>
                    </div>
                    <div id="admin-match-controls" class="hidden mt-8 pt-6 border-t border-white/10 space-y-3">
                        <button onclick="window.finalizarSet()" class="ios-btn w-full bg-green-600 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest">Finalizar Set e Salvar ‚úÖ</button>
                        <button onclick="window.zerarPlacar()" class="ios-btn w-full bg-white/5 py-3 rounded-2xl font-bold uppercase text-[9px] opacity-40">Zerar Placar sem Salvar</button>
                    </div>
                </div>

                <div id="next-match-card" class="glass-card rounded-[2rem] p-6 hidden">
                    <h3 class="text-[10px] font-black opacity-30 uppercase tracking-widest mb-4">Vem Pr√≥ximo:</h3>
                    <div id="next-match-info" class="space-y-3"></div>
                </div>
            </div>

            <div id="aba-lista" class="aba-content hidden space-y-4">
                <div class="glass-card rounded-[2.5rem] p-6 text-center">
                    <span class="text-[10px] font-black uppercase opacity-50">Caixa da Semana</span>
                    <div id="vpp" class="text-3xl font-black">R$ 0,00</div>
                    <div class="h-1.5 bg-white/10 rounded-full mt-4 overflow-hidden"><div id="barra" class="h-full bg-green-500 transition-all duration-700"></div></div>
                    <p id="infoFin" class="text-[9px] mt-2 opacity-40 font-bold uppercase">0/0 Pagos</p>
                </div>
                <button onclick="window.entrarNaLista()" class="ios-btn w-full bg-blue-600 py-4 rounded-2xl font-black uppercase text-xs">Me Adicionar ao Jogo</button>
                <div class="flex gap-2">
                    <input type="text" id="nomeConvidado" placeholder="Convidado..." class="glass-input flex-1">
                    <select id="nivelConvidado" class="glass-input w-20 text-center px-1 bg-black text-[10px] font-black">
                        <option value="1">‚≠ê 1</option><option value="2" selected>‚≠ê 2</option><option value="3">‚≠ê 3</option><option value="4">‚≠ê 4</option><option value="5">‚≠ê 5</option>
                    </select>
                    <button onclick="window.adicionarConvidado()" class="ios-btn bg-white/20 px-6 rounded-2xl font-black">+</button>
                </div>
                <ul id="listaJogadores" class="space-y-2"></ul>
                <button id="btnLimparSemana" onclick="window.limparListaSemana()" class="hidden w-full py-4 text-[9px] font-black uppercase opacity-20">Zerar Lista</button>
            </div>

            <div id="aba-sorteio" class="aba-content hidden space-y-4">
                <div class="glass-card rounded-[2.5rem] p-6 space-y-4 text-center">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-black uppercase opacity-40">Jogadores por Time</span>
                        <input type="number" id="qtdPorTime" value="6" class="bg-transparent text-right font-black text-2xl w-12 text-blue-500 outline-none">
                    </div>
                    <button onclick="window.animarESortear()" class="ios-btn w-full bg-white text-black py-5 rounded-2xl font-black uppercase">Sortear üé≤</button>
                </div>
                <div id="dica-troca" class="hidden text-center text-[9px] font-bold text-blue-400 uppercase tracking-widest pt-1">Toque nos nomes para trocar</div>
                <div id="resultadoSorteio" class="space-y-3"></div>
                <button id="btnAtivarMatch" onclick="window.ativarMatchSorteada()" class="hidden ios-btn w-full bg-blue-600 py-4 rounded-2xl font-black uppercase text-xs mt-4">Ativar Partida e Notificar üèê</button>
            </div>

            <div id="aba-ranking" class="aba-content hidden space-y-6">
                <div class="space-y-4">
                    <h2 class="text-center text-[10px] font-black opacity-40 uppercase tracking-widest">üèÜ Reis da Quadra</h2>
                    <ul id="listaRanking" class="glass-card rounded-3xl p-2 divide-y divide-white/5"></ul>
                </div>
                <div class="space-y-4">
                    <h2 class="text-center text-[10px] font-black opacity-40 uppercase tracking-widest">üïí Hist√≥rico</h2>
                    <div id="listaHistorico" class="space-y-4"></div>
                </div>
            </div>

            <div id="aba-perfil" class="aba-content hidden">
                <div class="glass-card rounded-[2.5rem] p-8 text-center flex flex-col items-center">
                    <img id="perfilFotoBadge" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full border-4 border-white/10 mb-4 object-cover">
                    <h2 id="perfilNomeBadge" class="text-2xl font-black uppercase">Atleta</h2>
                    <span id="perfilNivelBadge" class="px-4 py-1 bg-blue-500/20 text-blue-400 rounded-full text-[10px] font-black mt-2">N√çVEL 3</span>
                    <button onclick="window.editarPerfil()" class="ios-btn w-full mt-8 bg-white/10 py-4 rounded-2xl font-black uppercase text-xs">Editar Meus Dados</button>
                    
                    <button onclick="window.voltarLigas()" class="ios-btn w-full mt-4 bg-orange-600/20 text-orange-400 py-4 rounded-2xl font-black uppercase text-xs">Trocar de Liga</button>
                    
                    <button onclick="window.sair()" class="text-red-400 text-[10px] font-black uppercase mt-8 opacity-50">Sair da Conta</button>
                </div>
                <div id="perfil-edicao" class="glass-card rounded-[2.5rem] p-6 hidden space-y-4 mt-4 animate-in">
                    <input type="text" id="perfilNome" class="glass-input text-sm" placeholder="Seu Nome">
                    <input type="text" id="perfilFotoUrl" class="glass-input text-sm" placeholder="Link da Foto">
                    <select id="perfilNivel" class="glass-input bg-black text-white text-sm">
                        <option value="1">1 - Iniciante</option><option value="2">2 - B√°sico</option><option value="3" selected>3 - Intermedi√°rio</option><option value="4">4 - Avan√ßado</option><option value="5">5 - Profissional</option>
                    </select>
                    <button onclick="window.salvarPerfil()" class="ios-btn w-full bg-blue-600 py-4 rounded-2xl font-black uppercase text-xs">Salvar Altera√ß√µes</button>
                </div>
            </div>
        </main>

        <footer class="fixed bottom-4 left-0 w-full z-40 px-4">
            <nav class="glass-menu rounded-[2rem] p-1 flex justify-around items-center max-w-md mx-auto">
                <button onclick="window.mudarAba('placar')" id="btn-tab-placar" class="tab-btn active-tab p-4 flex flex-col items-center text-xl"><i class="fas fa-volleyball-ball"></i></button>
                <button onclick="window.mudarAba('lista')" id="btn-tab-lista" class="tab-btn opacity-40 p-4 flex flex-col items-center text-xl"><i class="fas fa-users"></i></button>
                <button onclick="window.mudarAba('sorteio')" id="btn-tab-sorteio" class="tab-btn opacity-40 p-4 flex flex-col items-center text-xl"><i class="fas fa-random"></i></button>
                <button onclick="window.mudarAba('ranking')" id="btn-tab-ranking" class="tab-btn opacity-40 p-4 flex flex-col items-center text-xl"><i class="fas fa-trophy"></i></button>
                <button onclick="window.mudarAba('perfil')" id="btn-tab-perfil" class="tab-btn opacity-40 p-4 flex flex-col items-center text-xl"><i class="fas fa-user"></i></button>
            </nav>
        </footer>
    </div>

    <div id="shufflingContainer" class="hidden">
        <div class="die">üé≤</div>
        <div class="mt-4 font-black text-blue-400 tracking-widest animate-pulse uppercase text-xs">Sorteando Times...</div>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-black/95 hidden">
        <div class="glass-card p-8 rounded-[2.5rem] w-full max-w-sm text-center space-y-4">
            <h2 class="text-xl font-black text-orange-400 uppercase tracking-widest">Painel Admin da Liga</h2>
            <div class="bg-white/5 p-4 rounded-2xl">
                <p class="text-[10px] font-black uppercase opacity-50 mb-2">Valor Quadra Semana</p>
                <input type="number" id="valorQuadraSemana" value="350" class="bg-transparent text-center text-2xl font-black text-green-400 outline-none w-full">
            </div>
            <div class="bg-white/5 p-4 rounded-2xl">
                <p class="text-[10px] font-black uppercase opacity-50 mb-1">Caixa Total Acumulado</p>
                <p id="adm-caixa" class="text-3xl font-black text-green-400">R$ 0,00</p>
            </div>
            <button onclick="window.fecharFinanceiro()" class="ios-btn w-full bg-green-600 py-4 rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-green-500/20">Finalizar e Pagar Semana ‚úÖ</button>
            <div class="text-left pt-2">
                <p class="text-[10px] font-black uppercase opacity-40 mb-2">Hist√≥rico de Pagamentos:</p>
                <ul id="listaFinanceira" class="text-[10px] space-y-1 h-32 overflow-y-auto pr-2 divide-y divide-white/5"></ul>
            </div>
            <button onclick="window.fecharAdmin()" class="ios-btn w-full bg-white/10 py-5 rounded-2xl font-black uppercase text-xs mt-2">Sair</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDoc, setDoc, where, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxQThqrjNEXmmpreEQwRBaihTAIpoZaAM",
            authDomain: "voleigrupo-b8a5a.firebaseapp.com",
            projectId: "voleigrupo-b8a5a",
            storageBucket: "voleigrupo-b8a5a.firebasestorage.app",
            messagingSenderId: "619450859287",
            appId: "1:619450859287:web:bf9138713eb65b3c514152"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        let colJogadores, colHistorico, colFinanceiro, placarRef, configRef;
        let ligaAtualId = null;
        let isLigaAdmin = false;
        let codigoLigaAtual = "";

        let userAtual = null, perfilAtual = null, jogadoresLocal = [], unsubscribes = [], valorQuadraAtual = 350, caixaTotalLocal = 0;
        let timesSorteadosGlobal = [], filaFilaGlobal = [], jogadorTroca = null;

        // --- AUTENTICA√á√ÉO ---
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, googleProvider).catch(err => alert(err.message));
        document.getElementById('email-login-btn').onclick = () => {
            const email = document.getElementById('emailInput').value, pass = document.getElementById('passInput').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => alert("Acesso inv√°lido"));
        };
        document.getElementById('register-btn').onclick = () => {
            const email = document.getElementById('emailInput').value, pass = document.getElementById('passInput').value;
            createUserWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
        };
        window.sair = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userAtual = user;
                document.getElementById('auth-screen').classList.add('hidden');
                await carregarPerfil();
                document.getElementById('league-screen').classList.remove('hidden');
                carregarLigasDisponiveis();
            } else {
                userAtual = null; 
                ligaAtualId = null;
                document.getElementById('auth-screen').classList.remove('hidden'); 
                document.getElementById('league-screen').classList.add('hidden');
                document.getElementById('main-app').classList.add('hidden');
                unsubscribes.forEach(u => u());
            }
        });

        async function carregarPerfil() {
            const s = await getDoc(doc(db, "usuarios", userAtual.uid));
            if (s.exists()) {
                perfilAtual = s.data();
                document.getElementById('perfilNomeBadge').innerText = perfilAtual.nome;
                document.getElementById('perfilFotoBadge').src = perfilAtual.fotoUrl || userAtual.photoURL || "https://via.placeholder.com/150";
                document.getElementById('perfilNivelBadge').innerText = "N√çVEL " + (perfilAtual.nivel || 3);
            } else { window.editarPerfil(); }
        }

        window.editarPerfil = () => document.getElementById('perfil-edicao').classList.toggle('hidden');
        window.salvarPerfil = async () => {
            const n = document.getElementById('perfilNome').value;
            if(!n) return alert("Insira um nome");
            await setDoc(doc(db, "usuarios", userAtual.uid), { nome: n.toUpperCase(), fotoUrl: document.getElementById('perfilFotoUrl').value, nivel: parseInt(document.getElementById('perfilNivel').value), uid: userAtual.uid });
            carregarPerfil();
        };

        // --- SISTEMA DE LIGAS COM C√ìDIGO ---
        function carregarLigasDisponiveis() {
            // Busca apenas ligas onde o usu√°rio √© membro
            const q = query(collection(db, "ligas"), where("membros", "array-contains", userAtual.uid));
            
            onSnapshot(q, snap => {
                const lista = document.getElementById('lista-ligas-disponiveis');
                lista.innerHTML = '';
                
                if(snap.empty) {
                    lista.innerHTML = '<div class="text-center opacity-40 text-xs mt-10">Voc√™ ainda n√£o participa de nenhuma liga.<br>Crie uma ou entre com um c√≥digo!</div>';
                    return;
                }

                snap.forEach(d => {
                    const l = d.data();
                    const adminTag = l.adminUid === userAtual.uid ? '<span class="text-[8px] bg-orange-500 text-white px-2 py-1 rounded-full font-black">üëë ADMIN</span>' : '';
                    lista.innerHTML += `
                        <div onclick="window.entrarLiga('${d.id}', '${l.nome}', '${l.adminUid}', '${l.codigo}')" class="glass-card p-5 rounded-[1.5rem] flex justify-between items-center cursor-pointer hover:bg-white/10 transition-colors animate-in">
                            <span class="font-bold tracking-wide">${l.nome}</span>
                            ${adminTag}
                        </div>`;
                });
            });
        }

        window.criarLiga = async () => {
            const nomeLiga = prompt("Qual o nome do seu novo Grupo ou Liga?");
            if(!nomeLiga) return;
            
            // Gera c√≥digo de 6 caracteres aleat√≥rios
            const codigoUnico = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const docRef = await addDoc(collection(db, "ligas"), {
                nome: nomeLiga.toUpperCase(),
                adminUid: userAtual.uid,
                criadoEm: Date.now(),
                codigo: codigoUnico,
                membros: [userAtual.uid] // Admin j√° entra como membro
            });
            
            await setDoc(doc(db, `ligas/${docRef.id}/sistema/configuracao`), { valorQuadra: 350 });
            await setDoc(doc(db, `ligas/${docRef.id}/sistema/match_atual`), { pontosA: 0, pontosB: 0 });
            
            alert(`Liga criada! O c√≥digo de convite √©: ${codigoUnico}`);
        };

        window.entrarComCodigo = async () => {
            const codigoInput = prompt("Digite o c√≥digo de 6 letras da Liga:");
            if(!codigoInput) return;
            
            const q = query(collection(db, "ligas"), where("codigo", "==", codigoInput.toUpperCase()));
            const querySnapshot = await getDocs(q);
            
            if(querySnapshot.empty) {
                alert("C√≥digo inv√°lido ou liga n√£o encontrada.");
                return;
            }
            
            // Pega o primeiro documento encontrado e adiciona o user
            const ligaDoc = querySnapshot.docs[0];
            await updateDoc(doc(db, "ligas", ligaDoc.id), {
                membros: arrayUnion(userAtual.uid)
            });
            
            alert("Voc√™ entrou na Liga com sucesso!");
        };

        window.entrarLiga = (id, nome, adminUid, codigo) => {
            ligaAtualId = id;
            isLigaAdmin = (userAtual.uid === adminUid);
            codigoLigaAtual = codigo || "ANTIGO";
            
            document.getElementById('nome-liga-header').innerText = nome;
            document.getElementById('codigo-texto').innerText = codigoLigaAtual;
            
            document.getElementById('btnAdmin').classList.toggle('hidden', !isLigaAdmin);
            document.getElementById('admin-match-controls').classList.toggle('hidden', !isLigaAdmin);
            document.getElementById('btnLimparSemana').classList.toggle('hidden', !isLigaAdmin);

            colJogadores = collection(db, `ligas/${ligaAtualId}/jogadores`);
            colHistorico = collection(db, `ligas/${ligaAtualId}/historico`);
            colFinanceiro = collection(db, `ligas/${ligaAtualId}/financeiro_fechado`);
            placarRef = doc(db, `ligas/${ligaAtualId}/sistema/match_atual`);
            configRef = doc(db, `ligas/${ligaAtualId}/sistema/configuracao`);

            document.getElementById('league-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            iniciarEscutas();
        };

        window.voltarLigas = () => {
            unsubscribes.forEach(u => u()); 
            unsubscribes = [];
            ligaAtualId = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('league-screen').classList.remove('hidden');
        };

        window.copiarCodigo = () => {
            if(codigoLigaAtual === "ANTIGO") return alert("Liga antiga n√£o possui c√≥digo. Recrie a liga.");
            navigator.clipboard.writeText(codigoLigaAtual);
            alert(`C√≥digo ${codigoLigaAtual} copiado! Envie para seus amigos.`);
        };

        // --- SISTEMA INTERNO DA LIGA ---
        function iniciarEscutas() {
            unsubscribes.push(onSnapshot(configRef, s => { if(s.exists()){ valorQuadraAtual = s.data().valorQuadra || 350; document.getElementById('valorQuadraSemana').value = valorQuadraAtual; } }));

            unsubscribes.push(onSnapshot(query(colJogadores, orderBy("nome")), snap => {
                const lista = document.getElementById('listaJogadores'); lista.innerHTML = ''; let pagos = 0;
                jogadoresLocal = snap.docs.map(d => ({id: d.id, ...d.data()}));
                jogadoresLocal.forEach(j => {
                    if(j.pago) pagos++;
                    
                    const btnPix = isLigaAdmin ? `<button onclick="window.togglePix('${j.id}', ${j.pago})" class="px-4 py-2 rounded-xl ${j.pago ? 'bg-green-600' : 'bg-red-600'} text-[9px] font-black">PIX</button>` : `<span class="text-[9px] font-bold ${j.pago ? 'text-green-500' : 'text-red-500'}">${j.pago ? 'OK' : 'PENDENTE'}</span>`;
                    const btnDel = (isLigaAdmin || userAtual.uid === j.uid) ? `<button onclick="window.deletar('${j.id}')" class="opacity-20 px-2"><i class="fas fa-trash"></i></button>` : '';
                    
                    const starHtml = isLigaAdmin 
                        ? `<div class="text-[9px] opacity-60 mt-1 cursor-pointer hover:text-blue-400 transition-colors" onclick="window.mudarNivel('${j.id}', ${j.nivel || 2})">${"‚òÖ".repeat(j.nivel||2)} <i class="fas fa-pen text-[8px] ml-1 opacity-50"></i></div>` 
                        : `<div class="text-[9px] opacity-40 mt-1">${"‚òÖ".repeat(j.nivel||2)}</div>`;
                        
                    lista.innerHTML += `<li class="glass-card p-4 rounded-2xl flex justify-between items-center"><div><div class="font-bold text-sm tracking-wide">${j.nome}</div>${starHtml}</div><div class="flex items-center gap-3">${btnPix}${btnDel}</div></li>`;
                });
                const vpp = jogadoresLocal.length > 0 ? valorQuadraAtual/jogadoresLocal.length : 0;
                document.getElementById('vpp').innerText = "R$ " + (pagos * vpp).toFixed(2);
                document.getElementById('barra').style.width = ((pagos/jogadoresLocal.length)*100) + "%";
                document.getElementById('infoFin').innerText = `${pagos}/${jogadoresLocal.length} Pagos`;
            }));

            // PLACAR E SISTEMA DE ROTATIVIDADE
            unsubscribes.push(onSnapshot(placarRef, s => {
                if(s.exists()){
                    const d = s.data();
                    document.getElementById('pontosA').innerText = d.pontosA || 0;
                    document.getElementById('pontosB').innerText = d.pontosB || 0;
                    document.getElementById('nomeA').value = d.nomeA || "TIME A";
                    document.getElementById('nomeB').value = d.nomeB || "TIME B";
                    
                    const nextMatchCard = document.getElementById('next-match-card');
                    const nextInfo = document.getElementById('next-match-info');
                    
                    let htmlProximos = "";
                    
                    if (d.timesProximos && d.timesProximos.length > 0) {
                        htmlProximos += d.timesProximos.map(t => `
                            <div class="w-full bg-white/5 p-3 rounded-xl mb-2">
                                <span class="text-[10px] font-black text-blue-400 block mb-1 uppercase tracking-widest">${t.nome}</span>
                                <span class="text-[11px] leading-relaxed opacity-90">${t.membros.join(', ')}</span>
                            </div>
                        `).join('');
                    }
                    
                    if (d.reservas && d.reservas.length > 0) {
                        htmlProximos += `
                            <div class="w-full mt-4 pt-4 border-t border-white/10">
                                <span class="text-[10px] font-black opacity-40 uppercase tracking-widest block mb-2">Fila de Reservas:</span>
                                <span class="text-[11px] leading-relaxed opacity-70">${d.reservas.join(', ')}</span>
                            </div>
                        `;
                    }

                    if (htmlProximos !== "") {
                        nextMatchCard.classList.remove('hidden');
                        nextInfo.innerHTML = htmlProximos;
                    } else { 
                        nextMatchCard.classList.add('hidden'); 
                    }
                }
            }));

            unsubscribes.push(onSnapshot(query(colHistorico, orderBy("criadoEm", "desc")), snap => {
                const histDiv = document.getElementById('listaHistorico'), rankUl = document.getElementById('listaRanking');
                histDiv.innerHTML = ''; rankUl.innerHTML = ''; let ranking = {}, acumulado = 0;

                snap.forEach(d => {
                    const p = d.data(); const pId = d.id;
                    acumulado += (p.arrecadado || 0);
                    let tHtml = p.times.map((t, i) => {
                        t.membros.forEach(m => { if(!ranking[m]) ranking[m]=0; ranking[m] += (t.vitorias || 0); });
                        return `<div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0"><div class="text-[11px] leading-relaxed w-2/3 tracking-wide">${t.membros.join(', ')}</div><div class="flex items-center gap-3"><span class="font-black text-blue-500">${t.vitorias || 0} vit</span></div></div>`;
                    }).join('');
                    
                    const btnDelHist = isLigaAdmin ? `<button onclick="window.delHist('${pId}')" class="admin-delete-btn ml-2"><i class="fas fa-trash text-lg"></i></button>` : '';
                    
                    histDiv.innerHTML += `<div class="glass-card p-6 rounded-[2rem] mb-4"><div class="flex justify-between items-center mb-3"><span class="text-[10px] opacity-30">${p.data}</span>${btnDelHist}</div>${tHtml}</div>`;
                });
                caixaTotalLocal = acumulado;
                Object.entries(ranking).sort((a,b)=>b[1]-a[1]).forEach(([n, v], i) => { if(v > 0) rankUl.innerHTML += `<li class="flex justify-between p-4 text-xs"><span>${i+1}¬∫ ${n}</span><span class="font-bold">${v} vit</span></li>`; });
            }));

            unsubscribes.push(onSnapshot(query(colFinanceiro, orderBy("data", "desc")), snap => {
                const list = document.getElementById('listaFinanceira'); list.innerHTML = '';
                snap.forEach(d => { 
                    const f = d.data(); const fId = d.id;
                    const btnDelF = isLigaAdmin ? `<button onclick="window.delFechamento('${fId}')" class="admin-delete-btn w-8 h-8 ml-2"><i class="fas fa-trash text-sm"></i></button>` : '';
                    list.innerHTML += `<li class="flex justify-between items-center py-2"><span>${f.dataString}</span><span class="text-green-400 font-bold flex items-center">R$ ${f.valor.toFixed(2)} ${btnDelF}</span></li>`; 
                });
            }));
        }

        window.mudarNivel = async (id, nivelAtual) => {
            let novoNivel = nivelAtual >= 5 ? 1 : nivelAtual + 1;
            await updateDoc(doc(db, `ligas/${ligaAtualId}/jogadores`, id), { nivel: novoNivel });
        };

        window.adicionarConvidado = async () => { 
            const i = document.getElementById('nomeConvidado'); 
            const n = document.getElementById('nivelConvidado').value;
            if(!i.value) return; 
            await addDoc(colJogadores, { uid: "c_"+Date.now(), nome: i.value.toUpperCase()+" (C)", nivel: parseInt(n), pago: false }); 
            i.value=""; 
        };

        window.ativarMatchSorteada = async () => {
            if(!timesSorteadosGlobal[0]) return;
            const matchData = {
                nomeA: timesSorteadosGlobal[0].nome || "TIME 1",
                nomeB: timesSorteadosGlobal[1] ? timesSorteadosGlobal[1].nome : "TIME 2",
                pontosA: 0,
                pontosB: 0,
                membrosA: timesSorteadosGlobal[0].membros,
                membrosB: timesSorteadosGlobal[1] ? timesSorteadosGlobal[1].membros : [],
                timesProximos: timesSorteadosGlobal.slice(2),
                reservas: filaFilaGlobal
            };
            await setDoc(placarRef, matchData);
            alert("Partida Ativada na Aba Placar!");
            window.mudarAba('placar');
        };

        window.alterarPlacar = async (time, valor) => {
            if(!isLigaAdmin) return alert("Apenas o admin da liga pode alterar o placar.");
            const s = await getDoc(placarRef);
            const d = s.exists() ? s.data() : { pontosA: 0, pontosB: 0 };
            const novoValor = Math.max(0, (d['pontos'+time] || 0) + valor);
            await updateDoc(placarRef, { ['pontos'+time]: novoValor });
        };

        window.finalizarSet = async () => {
            const s = await getDoc(placarRef);
            if(!s.exists()) return;
            const d = s.data();
            
            if (d.pontosA === d.pontosB) {
                return alert("A partida est√° empatada! Desempate antes de finalizar.");
            }

            const vencedor = d.pontosA > d.pontosB ? "A" : "B";
            const vpp = jogadoresLocal.length > 0 ? valorQuadraAtual/jogadoresLocal.length : 0;
            const partidaFinal = {
                criadoEm: Date.now(),
                data: new Date().toLocaleDateString(),
                arrecadado: jogadoresLocal.filter(j => j.pago).length * vpp,
                times: [
                    { nome: d.nomeA, membros: d.membrosA || [], vitorias: vencedor === "A" ? 1 : 0 },
                    { nome: d.nomeB, membros: d.membrosB || [], vitorias: vencedor === "B" ? 1 : 0 }
                ]
            };
            await addDoc(colHistorico, partidaFinal);

            if (d.timesProximos && d.timesProximos.length > 0) {
                const timeVencedor = { nome: vencedor === "A" ? d.nomeA : d.nomeB, membros: vencedor === "A" ? d.membrosA : d.membrosB };
                const timePerdedor = { nome: vencedor === "A" ? d.nomeB : d.nomeA, membros: vencedor === "A" ? d.membrosB : d.membrosA };

                const proximoEntrar = d.timesProximos[0];
                const novaFila = d.timesProximos.slice(1);
                novaFila.push(timePerdedor); 

                await updateDoc(placarRef, {
                    nomeA: timeVencedor.nome,
                    membrosA: timeVencedor.membros,
                    pontosA: 0,
                    nomeB: proximoEntrar.nome,
                    membrosB: proximoEntrar.membros,
                    pontosB: 0,
                    timesProximos: novaFila
                });
            } else {
                await updateDoc(placarRef, { pontosA: 0, pontosB: 0 });
            }
        };

        window.zerarPlacar = async () => await updateDoc(placarRef, { pontosA: 0, pontosB: 0 });

        window.entrarNaLista = async () => { if(!perfilAtual) return alert("Crie o perfil"); await addDoc(colJogadores, { uid: userAtual.uid, nome: perfilAtual.nome, nivel: perfilAtual.nivel, pago: false }); };
        window.togglePix = async (id, s) => await updateDoc(doc(db, `ligas/${ligaAtualId}/jogadores`, id), {pago: !s});
        window.deletar = async (id) => { if(confirm("Remover?")) await deleteDoc(doc(db, `ligas/${ligaAtualId}/jogadores`, id)); };
        window.limparListaSemana = async () => { if(confirm("Zerar?")) { for(let j of jogadoresLocal) await deleteDoc(doc(db, `ligas/${ligaAtualId}/jogadores`, j.id)); } };
        window.fecharFinanceiro = async () => {
            const v = parseFloat(document.getElementById('vpp').innerText.replace("R$ ", ""));
            if(confirm(`Fechar semana com R$ ${v.toFixed(2)}?`)) {
                await addDoc(colFinanceiro, { valor: v, data: Date.now(), dataString: new Date().toLocaleDateString() });
                alert("Fechado!");
            }
        };

        window.delHist = async (id) => { if(confirm("Deseja apagar este jogo do hist√≥rico?")) await deleteDoc(doc(db, `ligas/${ligaAtualId}/historico`, id)); };
        window.delFechamento = async (id) => { if(confirm("Deseja apagar este registro de pagamento?")) await deleteDoc(doc(db, `ligas/${ligaAtualId}/financeiro_fechado`, id)); };

        document.getElementById('valorQuadraSemana').onchange = async (e) => {
            if(e.target.value > 0) await setDoc(configRef, { valorQuadra: parseFloat(e.target.value) });
        };

        window.animarESortear = () => {
            if(jogadoresLocal.length < 2) return alert("M√≠nimo 2");
            document.getElementById('shufflingContainer').classList.remove('hidden');
            setTimeout(() => { document.getElementById('shufflingContainer').classList.add('hidden'); sortear(); }, 1200);
        };

        function sortear() {
            const q = parseInt(document.getElementById('qtdPorTime').value), n = Math.floor(jogadoresLocal.length / q);
            const ord = [...jogadoresLocal].sort((a,b) => (b.nivel||2) - (a.nivel||2));
            const times = Array.from({length: n}, (_, i) => ({ nome: "TIME " + (i+1), membros: [], nivelTotal: 0, vitorias: 0 }));
            ord.slice(0, n * q).forEach(j => {
                times.sort((a,b) => a.membros.length !== b.membros.length ? a.membros.length - b.membros.length : a.nivelTotal - b.nivelTotal);
                times[0].membros.push(j.nome); times[0].nivelTotal += (j.nivel||2);
            });
            const proximos = ord.slice(n * q).map(j => j.nome);
            
            timesSorteadosGlobal = times;
            filaFilaGlobal = proximos;
            renderSorteio();
        }

        function renderSorteio() {
            const res = document.getElementById('resultadoSorteio');
            res.innerHTML = timesSorteadosGlobal.map((t, i) => `
                <div class="glass-card p-5 rounded-3xl mb-3 animate-in">
                    <div class="text-[10px] text-blue-400 font-black mb-2 uppercase tracking-widest">${t.nome}</div>
                    <div class="text-[11px] leading-relaxed">
                        ${t.membros.map((m, j) => `<span onclick="window.trocar(${i},${j})" class="cursor-pointer transition-colors ${jogadorTroca && jogadorTroca.t===i && jogadorTroca.j===j ? 'bg-blue-600 px-2 py-1 rounded text-white font-bold' : 'hover:text-blue-300'}">${m}</span>`).join(', ')}
                    </div>
                </div>`).join('');
            
            if(filaFilaGlobal.length > 0) {
                res.innerHTML += `<div class="p-4 border border-dashed border-white/20 rounded-3xl text-[10px] opacity-60 tracking-wider">FILA: ${filaFilaGlobal.join(', ')}</div>`;
            }
            
            document.getElementById('dica-troca').classList.remove('hidden');
            document.getElementById('btnAtivarMatch').classList.remove('hidden');
        }

        window.trocar = (t, j) => {
            if(!jogadorTroca) { 
                jogadorTroca = {t, j}; 
                renderSorteio(); 
            } else {
                const j1 = timesSorteadosGlobal[jogadorTroca.t].membros[jogadorTroca.j], j2 = timesSorteadosGlobal[t].membros[j];
                timesSorteadosGlobal[jogadorTroca.t].membros[jogadorTroca.j] = j2; timesSorteadosGlobal[t].membros[j] = j1;
                jogadorTroca = null; 
                renderSorteio();
            }
        };

        window.mudarAba = (aba) => {
            document.querySelectorAll('.aba-content').forEach(a => a.classList.add('hidden'));
            document.getElementById('aba-'+aba).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.add('opacity-40'); b.classList.remove('active-tab'); });
            document.getElementById('btn-tab-'+aba).classList.remove('opacity-40');
            document.getElementById('btn-tab-'+aba).classList.add('active-tab');
        };

        window.abrirAdmin = () => { document.getElementById('adm-caixa').innerText = `R$ ${caixaTotalLocal.toFixed(2)}`; document.getElementById('admin-modal').classList.remove('hidden'); };
        window.fecharAdmin = () => document.getElementById('admin-modal').classList.add('hidden');
        window.copiarPix = () => { navigator.clipboard.writeText("11959154029"); alert("Pix Copiado"); };

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js').catch(e => console.log(e)); }
    </script>
</body>
</html>
