<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxQThqrjNEXmmpreEQwRBaihTAIpoZaAM",
        authDomain: "voleigrupo-b8a5a.firebaseapp.com",
        projectId: "voleigrupo-b8a5a",
        storageBucket: "voleigrupo-b8a5a.firebasestorage.app",
        messagingSenderId: "619450859287",
        appId: "1:619450859287:web:bf9138713eb65b3c514152"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    
    const EMAIL_ADMIN = "jhonata_hip.hop@hotmail.com";
    const placarRef = doc(db, "sistema", "placar_ao_vivo");

    let userAtual = null;
    let perfilAtual = null;
    let listeners = [];

    // --- LOGIN ---
    window.loginComGoogle = () => signInWithPopup(auth, googleProvider).catch(e => mostrarErro(e));
    window.fazerLogin = () => signInWithEmailAndPassword(auth, emailInput.value, passInput.value).catch(e => mostrarErro(e));
    window.sair = () => signOut(auth);

    function mostrarErro(e) {
        const err = document.getElementById('auth-error');
        err.innerText = "Erro: " + e.message;
        err.classList.remove('hidden');
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userAtual = user;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // UI Admin
            const isAdmin = user.email === EMAIL_ADMIN;
            document.getElementById('btnAdmin').classList.toggle('hidden', !isAdmin);
            document.getElementById('btnLimparSemana').classList.toggle('hidden', !isAdmin);
            document.getElementById('btnZerarPlacar').classList.toggle('hidden', !isAdmin);

            await carregarPerfil();
            iniciarApp();
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            listeners.forEach(unsub => unsub());
        }
    });

    async function carregarPerfil() {
        const snap = await getDoc(doc(db, "usuarios", userAtual.uid));
        if (snap.exists()) {
            perfilAtual = snap.data();
            document.getElementById('perfilNomeBadge').innerText = perfilAtual.nome;
            document.getElementById('perfilFotoBadge').src = perfilAtual.fotoUrl || userAtual.photoURL;
        } else {
            // Perfil novo
            editarPerfil();
        }
    }

    function iniciarApp() {
        // Escuta Jogadores
        listeners.push(onSnapshot(query(collection(db, "jogadores"), orderBy("nome")), snap => {
            renderizarLista(snap);
        }));

        // Escuta Histórico
        listeners.push(onSnapshot(query(collection(db, "historico"), orderBy("criadoEm", "desc")), snap => {
            renderizarHistoricoERanking(snap);
        }));

        // Escuta Placar (Sem tentar criar se falhar, apenas lê)
        listeners.push(onSnapshot(placarRef, snap => {
            if(snap.exists()){
                const d = snap.data();
                pontosA.innerText = d.pontosA; pontosB.innerText = d.pontosB;
            }
        }, err => console.log("Aguardando inicialização do placar...")));
    }

    // ... (restante das funções de sorteio e troca de jogadores permanecem iguais)
</script>
