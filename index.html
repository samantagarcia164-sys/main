<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vôlei Grupo - iOS 26 Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; -webkit-font-smoothing: antialiased; }
        .active-tab { border-bottom: 2px solid #007aff; font-weight: 600; color: #007aff; }
        .hidden { display: none; }
        @keyframes shuffle { 0% { opacity: 0.3; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.3; transform: scale(0.9); } }
        .shuffling-name { animation: shuffle 0.3s ease-in-out infinite; }
        .ios-input { background-color: rgba(239, 239, 240, 0.7); border: none; outline: none; transition: background-color 0.2s; }
        .ios-input:focus { background-color: rgba(239, 239, 240, 1); }
        .ios-btn { transition: opacity 0.2s, transform 0.1s; }
        .ios-btn:active { opacity: 0.7; transform: scale(0.98); }
        .ios-card { background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .status-badge { text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body class="bg-[#f2f2f7] min-h-screen text-[#1c1c1e]">

    <div class="max-w-md mx-auto min-h-screen flex flex-col p-4 space-y-4">
        
        <div class="flex items-center justify-between pt-2 pb-2">
            <h1 class="text-3xl font-extrabold tracking-tight">Vôlei Grupo</h1>
            <div class="flex items-center space-x-2">
                <span class="text-xs font-semibold text-gray-500">Quadra: 350,00</span>
            </div>
        </div>

        <div class="ios-card rounded-2xl p-4 flex items-center justify-between border border-[#e5e5ea]">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 font-medium">PIX</span>
                <span id="pixNumber" class="text-base font-semibold tracking-tight">11959154029</span>
            </div>
            <button onclick="copiarPix()" class="ios-btn text-[#007aff] text-sm font-semibold flex items-center space-x-1.5 p-2 rounded-xl bg-[#eef7ff]">
                <i class="far fa-copy"></i>
                <span>Copiar</span>
            </button>
        </div>

        <div id="pixNotificacao" class="fixed top-4 right-4 bg-[#1c1c1e] text-white px-4 py-2 rounded-full text-sm font-medium opacity-0 pointer-events-none transition-opacity duration-300 shadow-lg">
            Pix copiado!
        </div>

        <div class="flex border-b border-[#e5e5ea]">
            <button onclick="mudarAba('lista')" id="btn-lista" class="flex-1 py-3 active-tab text-center text-sm font-medium text-gray-600">Lista e Pagamento</button>
            <button onclick="mudarAba('sorteio')" id="btn-sorteio" class="flex-1 py-3 text-center text-sm font-medium text-gray-600">Sorteio de Times</button>
        </div>

        <div id="aba-lista" class="space-y-4">
            <div class="ios-card rounded-2xl p-4 border border-[#e5e5ea] space-y-3">
                <div class="flex justify-between items-center text-sm font-semibold">
                    <span class="text-gray-900">Total Arrecadado</span>
                    <span id="valorPorPessoa" class="text-gray-500">R$ 0,00 / pessoa</span>
                </div>
                <div class="w-full bg-[#e5e5ea] rounded-full h-3">
                    <div id="barraProgresso" class="bg-[#34c759] h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="statusFinanceiro" class="text-xs text-gray-500 font-medium text-center">R$ 0 de R$ 350 arrecadados</p>
            </div>

            <div class="flex gap-2 items-center">
                <input type="text" id="nomeJogador" placeholder="Nome do jogador..." class="ios-input flex-1 p-3.5 rounded-xl text-sm w-full">
                <button onclick="window.adicionarJogador()" class="ios-btn bg-[#007aff] text-white px-5 py-3.5 rounded-xl font-semibold shadow-sm text-sm flex items-center justify-center">
                    <i class="fas fa-plus mr-2 text-xs"></i> Add
                </button>
            </div>

            <ul id="listaJogadores" class="space-y-2.5"></ul>
        </div>

        <div id="aba-sorteio" class="space-y-4 hidden">
            <div class="ios-card rounded-2xl p-4 border border-[#e5e5ea]">
                <h2 class="font-bold text-[#3a3a3c] mb-3 flex items-center"><i class="fas fa-info-circle text-[#ff9500] mr-2"></i>Apenas jogadores com PIX OK serão sorteados.</h2>
                <div class="flex items-center gap-3">
                    <label class="text-sm font-medium text-gray-700">Jogadores por time:</label>
                    <input type="number" id="qtdPorTime" value="6" class="ios-input w-20 p-2.5 rounded-lg text-center font-semibold text-sm">
                </div>
                <button onclick="animarESortear()" class="ios-btn w-full mt-4 bg-[#ff9500] text-white py-3.5 rounded-2xl font-semibold shadow-sm hover:bg-[#ffaa33] text-sm uppercase tracking-wider">
                    <i class="fas fa-dice mr-2"></i> Sortear Times
                </button>
            </div>

            <div id="shufflingContainer" class="hidden text-center p-4">
                <p class="text-sm text-gray-500 font-medium mb-3">Misturando nomes...</p>
                <div id="shufflingNames" class="flex flex-wrap gap-2 justify-center text-sm font-medium text-gray-600">
                    </div>
            </div>
            
            <div id="resultadoSorteio" class="space-y-4">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxQThqrjNEXmmpreEQwRBaihTAIpoZaAM",
            authDomain: "voleigrupo-b8a5a.firebaseapp.com",
            projectId: "voleigrupo-b8a5a",
            storageBucket: "voleigrupo-b8a5a.firebasestorage.app",
            messagingSenderId: "619450859287",
            appId: "1:619450859287:web:bf9138713eb65b3c514152",
            measurementId: "G-7G4HZDHHYV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const jogadoresCol = collection(db, "jogadores");
        let jogadoresAtuais = [];

        // Controle de Abas iOS
        window.mudarAba = (aba) => {
            document.getElementById('aba-lista').classList.toggle('hidden', aba !== 'lista');
            document.getElementById('aba-sorteio').classList.toggle('hidden', aba !== 'sorteio');
            document.getElementById('btn-lista').classList.toggle('active-tab', aba === 'lista');
            document.getElementById('btn-sorteio').classList.toggle('active-tab', aba === 'sorteio');
        };

        // Copiar Pix
        window.copiarPix = () => {
            const pixNumber = document.getElementById('pixNumber').innerText;
            navigator.clipboard.writeText(pixNumber).then(() => {
                const notificacao = document.getElementById('pixNotificacao');
                notificacao.style.opacity = '1';
                setTimeout(() => {
                    notificacao.style.opacity = '0';
                }, 1500);
            }).catch(err => {
                console.error('Falha ao copiar Pix: ', err);
            });
        }

        // Escuta Banco de Dados
        const q = query(jogadoresCol, orderBy("nome", "asc"));
        onSnapshot(q, (snapshot) => {
            const lista = document.getElementById('listaJogadores');
            lista.innerHTML = '';
            jogadoresAtuais = [];
            
            let pagos = 0;
            snapshot.forEach((docSnap) => {
                const j = { id: docSnap.id, ...docSnap.data() };
                jogadoresAtuais.push(j);
                if(j.pago) pagos++;
                
                const item = document.createElement('li');
                item.className = `ios-card rounded-2xl p-4 flex justify-between items-center border border-[#e5e5ea] ${j.pago ? 'border-l-4 border-l-[#34c759]' : 'border-l-4 border-l-[#ff3b30]'}`;
                item.innerHTML = `
                    <span class="font-semibold text-gray-900 text-sm">${j.nome}</span>
                    <div class="flex items-center space-x-2.5">
                        <button onclick="window.togglePix('${j.id}', ${j.pago})" class="ios-btn status-badge text-[10px] px-3.5 py-1.5 rounded-lg font-bold text-white shadow-sm ${j.pago ? 'bg-[#34c759]' : 'bg-[#ff3b30]'}">
                            ${j.pago ? 'PIX OK' : 'PENDENTE'}
                        </button>
                        <button onclick="window.remover('${j.id}')" class="text-gray-400 hover:text-[#ff3b30] p-1 rounded-md text-sm"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                lista.appendChild(item);
            });

            atualizarFinanceiro(jogadoresAtuais.length, pagos);
        });

        function atualizarFinanceiro(totalPessoas, totalPagos) {
            const custoTotal = 350;
            const valorPorPessoa = totalPessoas > 0 ? (custoTotal / totalPessoas).toFixed(2) : "0.00";
            const arrecadado = (totalPagos * (custoTotal / totalPessoas || 0)).toFixed(0);
            const porcentagem = (totalPagos / totalPessoas * 100) || 0;

            document.getElementById('valorPorPessoa').innerText = `R$ ${valorPorPessoa} / pessoa`;
            document.getElementById('barraProgresso').style.width = `${porcentagem}%`;
            document.getElementById('statusFinanceiro').innerText = `${totalPagos} de ${totalPessoas} pessoas pagaram`;
        }

        window.adicionarJogador = async () => {
            const input = document.getElementById('nomeJogador');
            if (input.value.trim()) {
                await addDoc(jogadoresCol, { nome: input.value.trim(), pago: false, criadoEm: Date.now() });
                input.value = '';
                input.focus();
            }
        };

        window.togglePix = async (id, status) => {
            await updateDoc(doc(db, "jogadores", id), { pago: !status });
        };

        window.remover = async (id) => {
            if(confirm("Remover jogador da lista?")) await deleteDoc(doc(db, "jogadores", id));
        };

        // Lógica de Animação e Sorteio
        window.animarESortear = () => {
            const pagos = jogadoresAtuais.filter(j => j.pago);
            if (pagos.length < 2) return alert("Precisa de pelo menos 2 pessoas com PIX OK!");

            const shufflingContainer = document.getElementById('shufflingContainer');
            const shufflingNames = document.getElementById('shufflingNames');
            const resultadoDiv = document.getElementById('resultadoSorteio');
            const qtdPorTime = parseInt(document.getElementById('qtdPorTime').value);

            // Preparar Animação
            shufflingContainer.classList.remove('hidden');
            shufflingNames.innerHTML = '';
            resultadoDiv.innerHTML = '';
            
            // Adicionar nomes piscando
            pagos.forEach(j => {
                const nameSpan = document.createElement('span');
                nameSpan.className = 'shuffling-name';
                nameSpan.innerText = j.nome;
                shufflingNames.appendChild(nameSpan);
            });

            // Executar Sorteio após animação (1.5 segundos)
            setTimeout(() => {
                shufflingContainer.classList.add('hidden');
                sortearTimes(pagos, qtdPorTime);
            }, 1500);
        };

        function sortearTimes(pagos, qtdPorTime) {
            const resultadoDiv = document.getElementById('resultadoSorteio');
            
            // Shuffle (Embaralhar)
            const sorteados = pagos.sort(() => Math.random() - 0.5);
            resultadoDiv.innerHTML = '';

            let timeAtual = [];
            let contadorTime = 1;

            for (let i = 0; i < sorteados.length; i++) {
                timeAtual.push(sorteados[i].nome);
                
                if (timeAtual.length == qtdPorTime || i == sorteados.length - 1) {
                    const card = document.createElement('div');
                    card.className = "ios-card rounded-2xl p-4 border border-[#e5e5ea]";
                    card.innerHTML = `<h3 class="font-extrabold text-[#ff9500] mb-2.5 text-sm uppercase tracking-wider">TIME ${contadorTime}</h3>
                                      <p class="text-gray-900 text-sm font-semibold">${timeAtual.join(', ')}</p>`;
                    resultadoDiv.appendChild(card);
                    timeAtual = [];
                    contadorTime++;
                }
            }
        };
    </script>
</body>
</html>
